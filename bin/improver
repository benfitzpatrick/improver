#!/bin/bash
#------------------------------------------------------------------------------
# (C) British Crown Copyright 2017 Met Office.
#------------------------------------------------------------------------------
# NAME
#    improver - IMPROVER post-processing and verification operations
#
# SYNOPSIS
#    improver OPERATION [OPTIONS] [ARGS...] # Invoke an IMPROVER operation
#    improver help                     # Generic help across operations
#    improver help OPERATION           # Specific help for a particular operation
#    improver version                  # Print out version information
#
# DESCRIPTION
#    Launch particular operations for post-processing or verification of
#    meteorological data.
#------------------------------------------------------------------------------

set -eu

# List all improver subcommands or operations.
get_operations() {
    cd $(dirname $0)
    ls improver-* | sort | sed "s/^improver-//"
}

# Print generic or operation specific help.
print_help() {
    OPER=${1:-}
    if [[ -n "$OPER" ]] && [[ $OPER != all ]]; then
        # Operation-specific help.
        $(dirname $0)/improver $OPER --help
    else
        # General help.
        sed -n '/^# NAME/,/^#---/{/^#\-/d; s/^#//; s/^ //; p}' "$0"
        echo
        echo "OPERATIONS"
        echo -n "   improver "
        get_operations | sed "s/ /\n   improver /g"
    fi
}

# Print the version.
print_version() {
    cat etc/VERSION
}


HELP_TARGET=all
if (($# == 0)); then
    print_help
    exit 0
fi
if [[ $1 == help ]] || [[ $1 == --help ]]; then
    print_help ${2:-}
    exit 0
fi
if [[ $1 == version ]] || [[ $1 == --version ]]; then
    print_version
    exit 0
fi

OPER=$1
shift

# Apply site-specific setup if necessary.
if [[ -f etc/site-init ]]; then
    . etc/site-init
fi

# Put our library and scripts in the paths.
export IMPROVER_DIR=$(cd $(dirname $0)/../ && pwd -P)
export PYTHONPATH="$(dirname $0)/../lib/:${PYTHONPATH:-}"
export PATH="$(dirname $0):$PATH"

exec improver-$OPER "$@"
